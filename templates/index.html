<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Football Predictions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Virtual Football Predictions</h1>
            <p class="text-gray-600">Professional analysis and predictions for virtual leagues</p>
        </header>

        <!-- League Selector -->
        <div class="mb-8">
            <label for="league-select" class="block text-sm font-medium text-gray-700 mb-2">Select League:</label>
            <select id="league-select" class="w-full md:w-80 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Choose a league...</option>
            </select>
        </div>

        <!-- Tabs -->
        <div id="tabs-container" class="hidden mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-league-table" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                        <i class="fas fa-table mr-1"></i> League Table
                    </button>
                    <button id="tab-matches" class="tab-button py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">
                        <i class="fas fa-futbol mr-1"></i> Matches
                    </button>
                </nav>
            </div>
        </div>

        <!-- League Table Tab Content -->
        <div id="league-table-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 id="league-table-title" class="text-xl font-semibold text-gray-900">League Table</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th data-sort="position" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">Pos</th>
                                <th data-sort="team_name" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">Team</th>
                                <th data-sort="points" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">Pts</th>
                                <th data-sort="matches_played" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">MP</th>
                                <th data-sort="wins" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">W</th>
                                <th data-sort="draws" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">D</th>
                                <th data-sort="losses" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">L</th>
                                <th data-sort="goals_for" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">GF</th>
                                <th data-sort="goals_against" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">GA</th>
                                <th data-sort="goal_difference" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors">GD</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Last 5</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Matches Tab Content -->
        <div id="matches-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 id="matches-title" class="text-xl font-semibold text-gray-900">Upcoming & Recent Matches</h2>
                    <p class="text-sm text-gray-500 mt-1">Matches ordered by start time (earliest first), followed by completed games</p>
                </div>
                <div id="matches-list" class="divide-y divide-gray-200">
                    <!-- Matches will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const leagueSelect = document.getElementById('league-select');
            const tabsContainer = document.getElementById('tabs-container');
            const tabLeagueTable = document.getElementById('tab-league-table');
            const tabMatches = document.getElementById('tab-matches');
            const leagueTableTab = document.getElementById('league-table-tab');
            const matchesTab = document.getElementById('matches-tab');
            const tableBody = document.getElementById('table-body');
            const matchesList = document.getElementById('matches-list');
            const baseUrl = 'http://127.0.0.1:5000';

            let currentLeague = '';
            let tableData = [];
            let matchesData = [];
            let activeSlide = null;

            // Tab functionality
            function initTabs() {
                tabLeagueTable.addEventListener('click', () => switchTab('league-table'));
                tabMatches.addEventListener('click', () => switchTab('matches'));
                switchTab('league-table'); // Default tab
            }

            function switchTab(activeTab) {
                [leagueTableTab, matchesTab].forEach(tab => tab.classList.add('hidden'));
                [tabLeagueTable, tabMatches].forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });

                if (activeTab === 'league-table') {
                    leagueTableTab.classList.remove('hidden');
                    tabLeagueTable.classList.add('border-blue-500', 'text-blue-600');
                    tabLeagueTable.classList.remove('text-gray-500', 'border-transparent');
                    renderTable(tableData);
                } else if (activeTab === 'matches') {
                    matchesTab.classList.remove('hidden');
                    tabMatches.classList.add('border-blue-500', 'text-blue-600');
                    tabMatches.classList.remove('text-gray-500', 'border-transparent');
                    renderMatches(matchesData);
                }

                closePredictionSlide();
            }

            // Fetch leagues
            fetch(`${baseUrl}/leagues`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.leagues && Array.isArray(data.leagues)) {
                        data.leagues.forEach(league => {
                            const option = document.createElement('option');
                            option.value = league.value || league;
                            option.textContent = league.display || league;
                            leagueSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching leagues:', error);
                    showError('Failed to load leagues. Check server.');
                });

            // League select handler
            leagueSelect.addEventListener('change', () => {
                const league = leagueSelect.value;
                if (!league) return;

                currentLeague = league;
                tabsContainer.classList.remove('hidden');
                showLoading();

                Promise.all([
                    fetch(`${baseUrl}/matches/${encodeURIComponent(league)}`).then(r => r.json()),
                    fetch(`${baseUrl}/league_table/${encodeURIComponent(league)}`).then(r => r.json())
                ])
                .then(([matchesRes, tableRes]) => {
                    matchesData = sortMatches(matchesRes.matches || []);
                    tableData = tableRes.league_table || [];
                    updateTitles(matchesRes.league_display, tableRes.league_display);
                    switchTab('league-table');
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showError('Failed to load league data.');
                });
            });

            // Sort matches
            function sortMatches(matches) {
                const upcoming = matches.filter(m => m.type === 'scheduled' && m.status === 'scheduled');
                const completed = matches.filter(m => m.type !== 'scheduled' || m.status !== 'scheduled');

                upcoming.sort((a, b) => {
                    const timeA = parseTime(a.prediction_note?.match(/at (\d{2}:\d{2})/)?.[1] || a.start_time || a.match_time);
                    const timeB = parseTime(b.prediction_note?.match(/at (\d{2}:\d{2})/)?.[1] || b.start_time || b.match_time);
                    return timeA - timeB;
                });

                return [...upcoming, ...completed];
            }

            function parseTime(timeStr) {
                if (!timeStr || timeStr === 'TBD') return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Render matches
            function renderMatches(matches) {
                matchesList.innerHTML = '';
                if (!matches.length) {
                    matchesList.innerHTML = '<div class="p-6 text-center text-gray-500">No matches available</div>';
                    return;
                }

                const upcoming = matches.filter(m => m.type === 'scheduled');
                if (upcoming.length) {
                    const upcomingSection = document.createElement('div');
                    upcomingSection.innerHTML = `
                        <div class="px-6 py-4 bg-blue-50 border-b border-blue-100">
                            <h3 class="text-lg font-semibold text-blue-800"><i class="fas fa-clock mr-2"></i>Upcoming Matches</h3>
                        </div>
                    `;
                    upcomingSection.appendChild(createMatchesList(upcoming));
                    matchesList.appendChild(upcomingSection);
                }

                const completed = matches.filter(m => m.type !== 'scheduled');
                if (completed.length) {
                    const completedSection = document.createElement('div');
                    completedSection.innerHTML = `
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-100">
                            <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-check-circle mr-2"></i>Recent Completed Matches</h3>
                        </div>
                    `;
                    completedSection.appendChild(createMatchesList(completed));
                    matchesList.appendChild(completedSection);
                }
            }

            function createMatchesList(matchesGroup) {
                const container = document.createElement('div');
                matchesGroup.forEach(match => {
                    const matchItem = document.createElement('div');
                    matchItem.className = `match-item p-6 hover:bg-gray-50 transition-colors cursor-pointer border-b border-gray-100 last:border-b-0 ${!match.can_predict ? 'opacity-60 cursor-not-allowed' : ''}`;
                    matchItem.dataset.homeTeam = match.home_team;
                    matchItem.dataset.awayTeam = match.away_team;
                    matchItem.dataset.league = currentLeague;

                    const icon = match.can_predict ? '<i class="fas fa-bolt text-green-500 mr-2"></i>' : '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
                    const matchTime = match.prediction_note?.match(/at (\d{2}:\d{2})/)?.[1] || match.start_time || match.match_time || 'TBD';
                    const status = match.type === 'scheduled' ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${matchTime}</span>` : 
                                      `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">Completed</span>`;
                    const predictedScore = match.predicted_score ? `(${match.predicted_score})` : '';

                    matchItem.innerHTML = `
                        <div class="flex justify-between items-center match-header">
                            <div>
                                <h4 class="font-semibold text-gray-900">${match.home_team} <span class="text-gray-400">vs</span> ${match.away_team}</h4>
                                <p class="text-sm text-gray-600 mt-1">${match.prediction_note}</p>
                            </div>
                            <div class="text-right">
                                ${status}
                                <div class="text-xs text-gray-500 mt-1">${icon} ${match.can_predict ? predictedScore : 'No Data'}</div>
                            </div>
                        </div>
                        <div class="prediction-slide hidden bg-white rounded-lg shadow-xl mt-2 max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="slide-title text-xl font-bold text-gray-900">${match.home_team} vs ${match.away_team} - Prediction</h2>
                                    <button class="close-slide text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                                </div>
                                <div class="slide-content">
                                    <!-- Prediction content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    `;

                    if (match.can_predict) {
                        matchItem.querySelector('.match-header').addEventListener('click', () => togglePredictionSlide(matchItem, match.home_team, match.away_team));
                    }

                    matchItem.querySelector('.close-slide').addEventListener('click', (e) => {
                        e.stopPropagation();
                        closePredictionSlide();
                    });

                    container.appendChild(matchItem);
                });
                return container;
            }

            // Render table
            function renderTable(data) {
                tableBody.innerHTML = '';
                data.forEach(team => {
                    const row = document.createElement('tr');
                    const positionClass = team.position <= 3 ? 'bg-green-50' : team.position >= data.length - 2 ? 'bg-red-50' : '';
                    row.className = `${positionClass} hover:bg-gray-50 transition-colors`;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">${team.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-left font-medium text-gray-900">${team.team_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-lg text-gray-900">${team.points}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-500">${team.matches_played}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-green-600 font-medium">${team.wins}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-600">${team.draws}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-red-600">${team.losses}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-blue-600">${team.goals_for}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-red-500">${team.goals_against}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-medium ${team.goal_difference >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${team.goal_difference >= 0 ? '+' : ''}${team.goal_difference}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-xs">
                            ${formatLastResults(team.last_5_results)}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            function formatLastResults(results) {
                if (!results) return '';
                return results.replace(/,/g, '');
            }

            // Toggle prediction slide
            function togglePredictionSlide(matchItem, homeTeam, awayTeam) {
                const slide = matchItem.querySelector('.prediction-slide');
                const slideContent = matchItem.querySelector('.slide-content');

                if (activeSlide === slide) {
                    closePredictionSlide();
                    return;
                }

                closePredictionSlide();

                slideContent.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>';
                slide.classList.remove('hidden');
                setTimeout(() => {
                    slide.style.maxHeight = '600px';
                    activeSlide = slide;
                }, 10);

                fetch(`${baseUrl}/predict/${encodeURIComponent(currentLeague)}/${encodeURIComponent(homeTeam)}/${encodeURIComponent(awayTeam)}`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        if (data.prediction) {
                            const pred = data.prediction;
                            slideContent.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">
                                    <div class="text-center p-2 bg-blue-50 rounded-lg">
                                        <p class="text-xs text-gray-600">Home Win</p>
                                        <p class="text-lg font-bold text-blue-600">${pred.home_win_prob}%</p>
                                    </div>
                                    <div class="text-center p-2 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-600">Draw</p>
                                        <p class="text-lg font-bold text-gray-600">${pred.draw_prob}%</p>
                                    </div>
                                    <div class="text-center p-2 bg-red-50 rounded-lg">
                                        <p class="text-xs text-gray-600">Away Win</p>
                                        <p class="text-lg font-bold text-red-600">${pred.away_win_prob}%</p>
                                    </div>
                                </div>
                                <div class="mb-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                                    <p class="text-lg font-semibold text-center mb-2">Predicted: <span class="text-xl">${pred.predicted_result}</span> (${pred.predicted_score})</p>
                                    <div class="flex justify-center gap-3 mt-3">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${pred.over_2_5} 2.5</span>
                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">${pred.btts} BTTS</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <h3 class="font-semibold mb-2 text-sm">Analysis:</h3>
                                    <pre class="text-xs whitespace-pre-wrap text-gray-700">${pred.formatted}</pre>
                                </div>
                            `;
                        } else {
                            slideContent.innerHTML = '<p class="text-red-500 text-center">Prediction unavailable</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Prediction error:', error);
                        slideContent.innerHTML = '<p class="text-red-500 text-center">Error loading prediction</p>';
                    });
            }

            // Close slide
            function closePredictionSlide() {
                if (activeSlide) {
                    activeSlide.style.maxHeight = '0';
                    setTimeout(() => {
                        activeSlide.classList.add('hidden');
                        activeSlide = null;
                    }, 300);
                }
            }

            // Table sorting
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    const isNumeric = ['position', 'points', 'matches_played', 'wins', 'draws', 'losses', 'goals_for', 'goals_against', 'goal_difference'].includes(sortKey);
                    const ascending = header.classList.contains('border-blue-500');

                    document.querySelectorAll('th[data-sort]').forEach(h => h.classList.remove('border-blue-500'));
                    header.classList.add('border-blue-500');

                    tableData.sort((a, b) => {
                        let aVal = isNumeric ? Number(a[sortKey]) : a[sortKey].toLowerCase();
                        let bVal = isNumeric ? Number(b[sortKey]) : b[sortKey].toLowerCase();
                        return ascending ? (bVal > aVal ? 1 : -1) : (aVal > bVal ? 1 : -1);
                    });

                    renderTable(tableData);
                });
            });

            // Utilities
            function showLoading() {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';
                matchesList.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading matches...</div>';
            }

            function updateTitles(matchesDisplay, tableDisplay) {
                document.querySelector('h1').textContent = matchesDisplay || tableDisplay || 'Virtual Football Predictions';
                document.getElementById('league-table-title').textContent = `${tableDisplay || 'League Table'}`;
                document.getElementById('matches-title').textContent = `${matchesDisplay || 'Matches'}`;
            }

            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 border border-red-200 p-6 rounded-lg shadow text-center';
                errorDiv.innerHTML = `<p class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${message}</p>`;
                document.querySelector('.container').appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }

            // Initialize tabs
            initTabs();
        });
    </script>
</body>
</html>